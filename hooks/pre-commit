#!/usr/bin/env python
import configparser
import os
import git
from subprocess import check_output
from git import Repo

# setto la variabile con la directory attuale
dir_path = os.path.abspath(os.curdir)
# blocco per la lettura del file .ini
config = configparser.ConfigParser()
# costruzione percorso per file conf.ini
path_conf_file = os.path.join(dir_path, os.pardir)
path_conf_file = os.path.join(path_conf_file, "Git_Hook", "config_script",
                              "config.ini")
config.read(path_conf_file)
PERC_COMM_MIN = config.getint('Comments_Counter', 'Percentuale_Min_Comm')
# MP: sono presenti sia apici singoli che doppi apici per le stringhe. È meglio conformarsi a una singola soluzione
# (noi come team utilizziamo l'apice singolo, sia per stringhe di un solo carattere che per quelle più lunghe)


def _cut_useles(files):
    """
    Cut the useles part of a raw and take only the file to commit
    :param files: list of files to commit or not
    :return file_list: list with only file to commit
    """
    files_list = []
    files = files.split('\n')
    for i in range(len(files)):
    # MP: conviene usare 'for file in files', è più sintetico e l'interprete lo legge più velocemente
        if not files[i].startswith('?') and not files[i].startswith(' ') and \
           files[i].endswith('.py'):
            files[i] = files[i][2:]
            files[i] = files[i].strip(' ')
            files_list.append(files[i])
    return files_list

# inizializzo una variabile repository
repo = Repo(dir_path)
git = repo.git
# eseguo il comando git status
status = git.status('-s')
status = _cut_useles(status)
# creo il path per il main
program_path = os.path.join(dir_path, "Git_Hook", "Main.py")
for i in range(len(status)):
# MP: anche qui, come prima, conviene usare la sintassi for - in
    # passo al main ogni file su cui effettuo il conteggio dei commenti
    file = os.path.join(dir_path, status[i])
    perc = check_output(['python', program_path, file])
    perc = perc.decode()
    perc = perc.split('\r')
    if perc[0] == 'pydoc assente':
        print("Nel file: " + status[i] +
              " pydoc mancanti o non sempre presenti")
        exit(1)
    if float(perc[0]) < PERC_COMM_MIN:
        print("Nel file: " + status[i] + " i commenti sono meno del 30%")
        print('Percentuale commenti: ' + perc[0])
        exit(1)
    else:
        print('Nel file: ' + status[i] + ' hai commentato bene, bravo')
        print('Percentuale commenti: ' + perc[0] + '%')
exit(0)
